<!doctype html>
<html>
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width,initial-scale=1" />
		<title>Muserve Login</title>
<style>
</style>
	</head>
	<body>
		<p>Log in</p>
		<div class="card">
			<input id="email" type="email" placeholder="Email" />
			<input id="password" type="password" placeholder="Password" />
			<button id="loginButton">Log in</button>
			<small id="message"><small>
		</div>

		<script>
			async function login(email, password) {
				const res = await fetch(`/auth/login`, {
					method: "POST",
					headers: {"Content-Type": "application/json"},
					credentials: "include", // send/receive cookies with auth origin
					body: JSON.stringify({email, password}),
				});
				if (!res.ok) throw new Error(`login failed (${res.status})`);
				const data = await res.json();
				if (!data.action_token) throw new Error("Missing action_token");

				// stash action_token in the app session
				const s = await fetch("/session", {
					method: "POST",
					headers: {"Content-Type": "application/json"},
					body: JSON.stringify({action_token: data.action_token}),
				});
				if (!s.ok) throw new Error("Failed to store session");
				const ses_json = await s.json();
				// navigate to upload page
				location.href = (ses_json && ses_json.redirect) || "/upload";
			}

			window.addEventListener("DOMContentLoaded", () => {
				const email = document.getElementById("email");
				const password = document.getElementById("password");
				const button = document.getElementById("loginButton");
				const message = document.getElementById("message");

				button.addEventListener("click", async () => {
					message.textContent = "loggin in...";
					try {
						await login(email.value.trim(), password.value);
					} catch (e) {
						message.textContent = e.message || String(e);
					}
				});
			});
		</script>
	</body>
</html>
